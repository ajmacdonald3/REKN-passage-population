---
title: "Passage population estimate"
output:
  html_document: default
  pdf_document: default
subtitle: James Bay 2017
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = FALSE)
```

## Load and format data

This analysis requires the following packages:

```{r load_libraries}

library(tidyverse)
library(lubridate)
library(bb2enchist)
library(rjags)
library(car)
library(reshape)
library(jagsUI)

```

Reformat bandedbirds.org resighting data into encounter histories:

```{r create_enchist}

# Use bb2enchist to transform data
bandedbirds <- readRDS("./data-files/ALLCAMPS2017_bandedbirds_resights.rds")
resight_periods <- readRDS("./data-files/ALLCAMPS2017_resightperiods.rds")

# Remove NP data
bandedbirds <- bandedbirds %>%
  fill(LocationID) %>% 
  filter(!str_detect(LocationID, "NORTHBLUFFPT"))

resight_data <- bandedbirds %>% 
  filter(is.na(ResightCertainty) | ResightCertainty > 94 | ResightCertainty == 100)

resight_data <- format_bandedbirds(resight_data, sp = "REKN", cert = FALSE)

resight_data_custom <- custom_period(resight_data, resight_periods)

create_enchist(resight_data_custom)

# Add all-zero encounter histories representing potential recruits that were not 
# detected (parameter-expanded data augmentation)
enchist_pxda <- enchist_csv %>% 
  add_row(FlagID = paste0("PXDA", 1:500)) %>% 
  replace(., is.na(.), "0")

```

Reformat flag and age ratio scan data for analysis:

```{r ratio_data}

ratio_data <- readRDS("./data-files/ALLCAMPS2017_bandedbirds_ratios.rds")

# isolate flag ratio data
flag_data <- ratio_data %>% 
  mutate(K = (`Num. Marked` + `Num. Unmarked`)) %>% 
  dplyr::rename(m = `Num. Marked`) %>% 
  select(ResightDate, m, K) %>%
  filter(!K==0) %>%
  na.omit()

# assign flag scans to resight periods
flag_data <- left_join(flag_data, resight_periods) %>% 
  select(ResightPeriod, m, K) %>% 
  dplyr::rename(per = ResightPeriod)

# isolate age ratio data
age_data <- ratio_data %>% 
  mutate(Tot = (Adult + Juvenile)) %>% 
  dplyr::rename(a = Adult) %>% 
  select(ResightDate, a, Tot) %>% 
  na.omit()

# assign age scans to resight periods
age_data <- left_join(age_data, resight_periods) %>% 
  select(ResightPeriod, a, Tot) %>% 
  dplyr::rename(rper = ResightPeriod) %>% 
  na.omit()

```

## Embed JAGS code

Embed JAGS code so that program can be run from R:

```{r JAGS_setup}

# embed JAGS code for IPM
source("./analysis-code/JAGScode_superpop_phitpc.R")

```

## Run Integrated Population Model (IPM)

Format datasets for analysis in JAGS:

```{r organize_data}

# convert FlagID to row names so a numeric matrix can be generated
enchist <- enchist_pxda %>% 
  column_to_rownames(var = "FlagID") %>% 
  select_all(.funs = funs(paste0("P", .)))
  
enchist <- data.matrix(enchist)

# bundle data
jags_data <- list(y = enchist, n.occasions = dim(enchist)[2], M = dim(enchist)[1],
                  n.ch = dim(enchist)[2],
                  m = flag_data$m, K = flag_data$K, n = length(flag_data$K), per = flag_data$per,
                  a = age_data$a, Tot = age_data$Tot, n2 = length(age_data$Tot), rper = age_data$rper,
                  n.per = length(unique(age_data$rper)))


```

Set priors, parameters to estimate, and MCMC specifications:

```{r bayesian_settings}

# intial values
z.init <- enchist
z.init[z.init==0] <- 1
w.init <- rep(1, nrow(enchist))

inits <- function(){list(phi_t = runif(dim(enchist)[2]-1, 0, 1),
                         mean.p = runif(1, 0, 1),
                         psi = runif(1, 0, 1),
                         z = z.init,
                         w = w.init,
                         alpha = runif(1, -1, 1),
                         delta = runif(14, -1, 1),
                         beta.rper = runif(14, -1, 1))}  

# parameters monitored
parameters <- c("psi", "phi_t", "mean.p", "b", "nu",
                "delta", "pflag", "meanpflag",
                "beta.rper", "padult", "meanpadult",
                "Nflag", "Nstopadult", "Nstop_t",
                "Bflag", "Bstopadult", "Bstop_t",
                "Nsuperflag", "Nsuperstopadult",
                "Nsuperstop_Bt", "zes.days")

# MCMC settings
ni <- 60000 # number of iterations
nt <- 4 # thin by factor
nb <- 30000 # burn-in
nc <- 3 # number of chains

```

Run the IPM:

```{r run_model}

# Call JAGS from R
PISKLR2017_superpop_phitpc <- jags(jags_data, inits, parameters,
                            "js-super.jags",
                            n.chains = nc, n.thin = nt, n.iter = ni, n.burnin = nb,
                            DIC= TRUE,
                            parallel = TRUE)

# view results
print(PISKLR2017_superpop_phitpc, digits = 3)

traceplot(PISKLR2017_superpop_phitpc, mfrow = c(2, 2))

pdf(file = paste0("./analysis-output/PISKLR2017_superpop_phitpc_traceplots_", Sys.Date(), ".pdf"))
traceplot(PISKLR2017_superpop_phitpc, mfrow = c(2, 3))
dev.off()

# export results as CSV file
write.csv(PISKLR2017_superpop_phitpc$summary,
          file = paste0("./analysis-output/PISKLR2017_superpop_phitpc_summary_", Sys.Date(), ".csv"))

# write.table(x=PISKLR2017_superpop_phitpc$DIC, file=paste0("PISKLR2017_superpop_phitpc_DIC_", Sys.Date(), ".txt"), sep="\t")
# 
# write.table(x = print(PISKLR2017_superpop_phitpc, digits = 3), file=paste0("PISKLR2017_superpop_phitpc_DIC_", Sys.Date(), ".txt"), sep="\t") # not working, just copy paste

# export more results for stopover duration
write.csv(PISKLR2017_superpop_phitpc$sims.list,
          file = paste0("./analysis-output/PISKLR2017_superpop_phitpc_sims.list_", Sys.Date(), ".csv"))


```



